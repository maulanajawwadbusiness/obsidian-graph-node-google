# AppShell Modularization Plan (Target: <450 Lines)

Date: 2026-02-21
Scope: `src/screens/AppShell.tsx`
Current size: 1150 lines
Goal: reduce `AppShell.tsx` to under 450 lines with strict concern ownership and no behavior drift.

## 1. Problem Statement

`AppShell.tsx` still centralizes too many orchestration concerns:
- graph loading gate state, timers, visual phase, and keyboard guards
- saved interface local and remote sync wiring
- sidebar guard policies and action handlers
- modal engines and overlay controllers
- transition routing policy and content fade policy
- debug and instrumentation effects
- final screen rendering and data wiring

This weakens maintainability and increases regression risk, especially around gate flow, sidebar lock policy, and restore/switch fades.

## 2. Invariants To Preserve

Non-negotiable behavior contracts during refactor:
- `prompt -> graph` direct transition remains blocked and routed to `graph_loading`
- graph loading gate remains the only user-visible gate for graph loading path
- gate fade enter/exit timing and failsafe behavior remains intact
- sidebar freeze, dim, and lock reason behavior remains parity-safe
- overlays/modals shield pointer and wheel from graph runtime beneath
- saved interface contracts remain intact:
  - single writer commit seam
  - restore read-only path behavior
  - ordering by payload timestamps
  - outbox retry and identity isolation
- onboarding fade and reduced-motion behavior remains parity-safe

## 3. Target Module Ownership

Keep `AppShell.tsx` as composition-only orchestrator. Move policy-heavy logic into hooks and adapters under `src/screens/appshell/`.

### 3.1 Proposed New Files

- `src/screens/appshell/orchestration/appShellTypes.ts`
  - `Screen`, gate helper types, local orchestration-only types
- `src/screens/appshell/orchestration/appShellConstants.ts`
  - `STORAGE_KEY`, `PERSIST_SCREEN`, watchdog ms, sidebar by-screen maps, fallback messages
- `src/screens/appshell/orchestration/useReducedMotionPreference.ts`
  - reduced-motion media query effect
- `src/screens/appshell/orchestration/useGraphRuntimeTelemetry.ts`
  - graph runtime status state + noop counters + status-change handlers
- `src/screens/appshell/gate/useGraphLoadingGateController.ts`
  - gate phase, entry intent, seen-loading logic, exit request, timers, failsafe, confirm/back handlers, focus ownership
- `src/screens/appshell/sidebar/useSidebarViewModel.ts`
  - derive visibility, frozen state, dim alpha, expanded render clamp, lock model
- `src/screens/appshell/sidebar/createSidebarActions.ts`
  - guarded callbacks for toggle/create/search/doc-viewer/rename/delete/select
- `src/screens/appshell/savedInterfaces/useSavedInterfacesController.ts`
  - local persistence wiring, sync hook integration, commit surfaces integration, selection flow, fade action routing
- `src/screens/appshell/render/createRenderScreenContentAdapter.ts`
  - stable adapter object for `renderScreenContent` call contract
- `src/screens/appshell/debug/useAppShellDevGuards.ts`
  - dev-only logs and invariant guards currently in AppShell effects
- `src/screens/appshell/render/AppShellMainLayout.tsx`
  - shell layout render wrapper:
  - sidebar layer
  - non-sidebar layer
  - onboarding chrome
  - money ui
  - content fade overlay
  - modal layer

## 4. Sharp Concern Rules

Rule set for future code:
- `AppShell.tsx` may compose hooks and pass props; it must not own timer orchestration.
- Any `window.addEventListener` or timer lifecycle must live inside dedicated hooks only.
- `AppShell.tsx` must not contain business-policy `if` trees for saved interface mutation paths.
- Sidebar action blocking and warning logic must live in one adapter (`createSidebarActions`).
- Dev-only guard effects must be isolated in one debug hook and tree-shaken by `import.meta.env.DEV` checks.
- render contract mapping to `renderScreenContent` must be generated by a dedicated adapter factory.

## 5. Refactor Phases

### Phase 1: Static extraction
1. Move constants and local types to `orchestration/appShellConstants.ts` and `orchestration/appShellTypes.ts`.
2. Keep runtime behavior unchanged.

### Phase 2: Runtime and preference hooks
1. Extract reduced-motion media query effect.
2. Extract graph runtime telemetry and status-change handlers.
3. Keep current signatures for `onGraphLoadingStateChange` and `onGraphRuntimeStatusChange`.

### Phase 3: Gate controller extraction
1. Move all gate phase, visual phase, exit timers, watchdog, confirm/back handlers, and focus guards into `useGraphLoadingGateController`.
2. Expose a compact gate view-model:
   - state (`phase`, `visualPhase`, `interactionLocked`, `controls`, `errorMessage`)
   - handlers (`confirm`, `backToPrompt`, `requestExit`)
   - refs needed by render path (`gateRootRef`)
3. Preserve existing logs and failsafe semantics.

### Phase 4: Saved interfaces controller extraction
1. Move saved-interface persistence + sync + commit surfaces wiring into `useSavedInterfacesController`.
2. Move select/create-new/fade flow logic and pending action ref there.
3. Return compact API:
   - `savedInterfaces`, `sidebarInterfaces`
   - `pendingLoadInterface`, `pendingAnalysis`
   - `actions` (`selectById`, `rename`, `delete`, `createNew`, `upsert`, `patchLayout`)
   - content-fade state and handlers

### Phase 5: Sidebar VM and action adapter
1. Create `useSidebarViewModel` for derived lock/freeze/dim visibility model.
2. Create `createSidebarActions` for guard-wrapped callbacks and warning hooks.
3. Remove inline action lambdas from JSX in `AppShell.tsx`.

### Phase 6: Render adapter and layout component
1. Build `createRenderScreenContentAdapter` to generate props contract for `renderScreenContent`.
2. Move shell JSX markup into `AppShellMainLayout.tsx`.
3. Keep `AppShell.tsx` limited to state assembly and one return call.

### Phase 7: Dev guard isolation
1. Move dev-only effects (render loop guard logs, sidebar lock transitions, focus guards, invariants) into `useAppShellDevGuards`.
2. Keep same log tags and cadence.

### Phase 8: Final budget pass
1. Remove residual local helpers from `AppShell.tsx`.
2. Ensure file stays under 450 lines with clear section markers:
   - imports
   - core state
   - hooks assembly
   - render composition

## 6. Line Budget Targets

Target budgets:
- `src/screens/AppShell.tsx`: 320-430
- `useGraphLoadingGateController.ts`: 220-380
- `useSavedInterfacesController.ts`: 220-380
- `createSidebarActions.ts`: 120-220
- `AppShellMainLayout.tsx`: 180-320
- `createRenderScreenContentAdapter.ts`: 120-220
- `useAppShellDevGuards.ts`: 120-220

Constraint:
- avoid creating new single-file monoliths above 500 lines

## 7. Verification Matrix

Manual verification required:

Screen flow:
- welcome1/welcome2/prompt/onboarding transitions unchanged
- prompt submit routes to `graph_loading`
- `prompt -> graph` direct route remains blocked

Graph loading gate:
- enter fade and exit fade timing unchanged
- `done` state allows confirm and transitions to `graph`
- error state shows back path and returns to `prompt`
- escape behavior works as before
- failsafe exits if normal timer path stalls

Sidebar:
- lock reason values unchanged
- graph loading freezes sidebar correctly
- sidebar expanded state restoration across graph_loading boundary unchanged
- all sidebar actions enforce frozen/disabled guard behavior

Saved interfaces:
- rename/delete/select/create-new behavior unchanged
- restore path remains read-only safe
- remote outbox sync still triggers through existing sync seam

Overlays and modals:
- profile/logout/search/delete modals open/close unchanged
- pointer and wheel shielding remains intact

Performance and debug:
- dev logs still emit with existing tags
- no new repeated listener leaks
- render count guard cadence remains unchanged

## 8. Risk Register

Risk: gate behavior drift during hook extraction.
Mitigation: move logic with parity-first copy, then minimal normalization.

Risk: stale closure bugs in extracted action adapters.
Mitigation: explicit dependency arrays and adapter factories with typed inputs.

Risk: regression in saved interface commit ordering.
Mitigation: keep `createSavedInterfacesCommitSurfaces` as single writer seam and avoid rewriting commit semantics.

Risk: accidental overlay input leak.
Mitigation: do not move pointer-shield ownership out of existing overlay modules; only move orchestration.

## 9. Definition Of Done

Done when all conditions are true:
- `src/screens/AppShell.tsx` is under 450 lines
- all major concerns are isolated into dedicated hooks/adapters/components with clear ownership
- full verification matrix passes manually
- architecture docs updated if seam ownership changes:
  - `docs/repo_xray.md`
  - `docs/system.md` if runtime flow ownership is materially changed

